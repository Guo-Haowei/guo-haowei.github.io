(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();function P(i){return i===i.toLowerCase()&&i!==i.toUpperCase()}function T(i,e){return`${String.fromCharCode(97+i)}${e+1}`}function S(i){const e=i.charCodeAt(0)-97,t=i.charCodeAt(1)-49;return[e,t]}class U{constructor(){this.reset()}reset(){this._square="",this._piece="",this._moves=void 0}onMouseUp(e,t){const n=l.display.tileSize,s=Math.floor(e/n),r=7-Math.floor(t/n),o=T(s,r),{board:c}=l.gameManager;if(this._moves&&this._moves.has(o)){this.sendMove(o);return}const u=c.legalMoves(o);u!==void 0?(this._moves=u,this._square=o,this._piece=c.board[s+r*8]):this.reset()}sendMove(e){const t=this._square,n=parseInt(e[1],10),s=n===8&&this._piece==="P",r=n===1&&this._piece==="p";(s||r)&&(console.log(`Promoting ${this._piece} at ${t} to a different piece.`),console.log(`Dest is is ${s?"white":"black"} at rank ${n}.`),console.log(`moving from ${t} to ${e}.`));const o=(s||r)&&prompt("Enter what piece to promote: ")||"",c=`${t}${e}${o}`;l.gameManager.injectMove(c),this.reset()}get square(){return this._square}get moves(){return this._moves}get piece(){return this._piece}}const I=new U;class B{constructor(){this.NEW_GAME="newgame",this.GAME_OVER="gameover",this.REQUEST_PLAYER_INPUT="request-player-input",this.MOVE="move",this.ANIMATION_DONE="animation-done"}}const f=new B;class F{constructor(){this.queue=[],this.listeners=new Map;for(const e of Object.keys(f)){const t=f[e];this.listeners.set(t,[])}}init(){var n;const e=l.display.canvas,t=(s,r)=>{const o=s.getBoundingClientRect(),c=r.clientX-o.left,u=r.clientY-o.top;return{x:c,y:u}};return(n=document.getElementById("fenButton"))==null||n.addEventListener("click",()=>{this.emit(f.NEW_GAME)}),e.addEventListener("mousedown",s=>{const{x:r,y:o}=t(e,s);console.log(`Mouse down at (${r}, ${o})`),I.onMouseUp(r,o)}),window.addEventListener("resize",()=>{l.display.onResize()}),!0}tick(){this.flush()}subscribe(e,t){if(!this.listeners.has(e)){console.error(`event '${e}' is not supported.`);return}const n=this.listeners.get(e);n?n.push(t):console.error(`No listeners found for event '${e}'.`)}emit(e){this.queue.push(e)}flush(){const e=this.queue.length;for(let t=0;t<e;++t){const n=this.queue.shift();if(!n){console.error("MessageQueue: flush called with empty queue");break}const s=n.split(":")[0],r=this.listeners.get(s);if(!r){console.error(`MessageQueue: no listeners found for event '${s}'`);continue}r.forEach(o=>{o.handleMessage(n)})}}}class D{constructor(){this._animations=[],this.lastTime=0}init(){return l.messageQueue.subscribe(f.MOVE,this),this.lastTime=Date.now(),!0}tick(){const e=Date.now(),t=e-this.lastTime;if(this.lastTime=e,this._animations.length===0)return;const n=this._animations.filter(s=>(s.timeLeft-=t,s.timeLeft<=0?!1:(s.x+=s.dx*t,s.y+=s.dy*t,!0)));this._animations=n,this._animations.length===0&&l.messageQueue.emit(`${f.ANIMATION_DONE}:`)}handleMessage(e){const[t,n]=e.split(":");switch(t){case f.MOVE:this.addAnimation(n.slice(0,2),n.slice(2,4));break}}get animations(){return this._animations}addAnimation(e,t){const[n,s]=S(e),[r,o]=S(t),c=r+o*8,u=l.gameManager.board.board[c],d=300*Math.sqrt((r-n)**2+(o-s)**2),M=d,q=n,z=7-s,$=-(o-s)/d,C=(r-n)/d,Q={piece:u,x:q,y:z,dy:$,dx:C,dstFile:r,dstRank:o,duration:d,timeLeft:M};this._animations.push(Q)}}const _=8,R="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",k={light:"#f0d9b5",dark:"#b58863"},W={r:"♜",n:"♞",b:"♝",q:"♛",k:"♚",p:"♟",R:"♖",N:"♘",B:"♗",Q:"♕",K:"♔",P:"♙"};class G{constructor(){this._tileSize=0;const e=document.getElementById("chessCanvas");this._canvas=e,e.tabIndex=0,e.style.margin="20px auto",this.onResize(800)}get canvas(){return this._canvas}get tileSize(){return this._tileSize}init(){return!0}tick(){}onResize(e=200){const t=this._canvas;let n=Math.min(t.clientWidth,t.clientHeight);n=Math.max(n,e),t.width=n,t.height=n,this._tileSize=n/(_+1),console.log(`tile size is ${this._tileSize}`)}}let a;const L=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&L.decode();let w=null;function y(){return(w===null||w.byteLength===0)&&(w=new Uint8Array(a.memory.buffer)),w}function h(i,e){return i=i>>>0,L.decode(y().subarray(i,i+e))}let m=0;const v=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},V=typeof v.encodeInto=="function"?function(i,e){return v.encodeInto(i,e)}:function(i,e){const t=v.encode(i);return e.set(t),{read:i.length,written:t.length}};function E(i,e,t){if(t===void 0){const c=v.encode(i),u=e(c.length,1)>>>0;return y().subarray(u,u+c.length).set(c),m=c.length,u}let n=i.length,s=e(n,1)>>>0;const r=y();let o=0;for(;o<n;o++){const c=i.charCodeAt(o);if(c>127)break;r[s+o]=c}if(o!==n){o!==0&&(i=i.slice(o)),s=t(s,n,n=o+i.length*3,1)>>>0;const c=y().subarray(s+o,s+n),u=V(i,c);o+=u.written,s=t(s,n,o,1)>>>0}return m=o,s}let g=null;function x(){return(g===null||g.buffer.detached===!0||g.buffer.detached===void 0&&g.buffer!==a.memory.buffer)&&(g=new DataView(a.memory.buffer)),g}function j(i,e){i=i>>>0;const t=x(),n=[];for(let s=i;s<i+4*e;s+=4)n.push(a.__wbindgen_export_3.get(t.getUint32(s,!0)));return a.__externref_drop_slice(i,e),n}function Y(){let i,e;try{const t=a.name();return i=t[0],e=t[1],h(t[0],t[1])}finally{a.__wbindgen_free(i,e,1)}}const A=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(i=>a.__wbg_wasmgame_free(i>>>0,1));class K{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,A.unregister(this),e}free(){const e=this.__destroy_into_raw();a.__wbg_wasmgame_free(e,0)}constructor(){const e=a.wasmgame_new();return this.__wbg_ptr=e>>>0,A.register(this,this.__wbg_ptr,this),this}reset_game(e,t,n){const s=E(e,a.__wbindgen_malloc,a.__wbindgen_realloc),r=m;a.wasmgame_reset_game(this.__wbg_ptr,s,r,t,n)}get_move(){const e=a.wasmgame_get_move(this.__wbg_ptr);let t;return e[0]!==0&&(t=h(e[0],e[1]).slice(),a.__wbindgen_free(e[0],e[1]*1,1)),t}make_move(e){const t=E(e,a.__wbindgen_malloc,a.__wbindgen_realloc),n=m;return a.wasmgame_make_move(this.__wbg_ptr,t,n)!==0}get_legal_moves(){const e=a.wasmgame_get_legal_moves(this.__wbg_ptr);var t=j(e[0],e[1]).slice();return a.__wbindgen_free(e[0],e[1]*4,4),t}inject_move(e){const t=E(e,a.__wbindgen_malloc,a.__wbindgen_realloc),n=m;a.wasmgame_inject_move(this.__wbg_ptr,t,n)}fen(){let e,t;try{const n=a.wasmgame_fen(this.__wbg_ptr);return e=n[0],t=n[1],h(n[0],n[1])}finally{a.__wbindgen_free(e,t,1)}}debug_string(){let e,t;try{const n=a.wasmgame_debug_string(this.__wbg_ptr);return e=n[0],t=n[1],h(n[0],n[1])}finally{a.__wbindgen_free(e,t,1)}}game_over(){return a.wasmgame_game_over(this.__wbg_ptr)!==0}can_undo(){return a.wasmgame_can_undo(this.__wbg_ptr)!==0}can_redo(){return a.wasmgame_can_redo(this.__wbg_ptr)!==0}undo(){return a.wasmgame_undo(this.__wbg_ptr)!==0}redo(){return a.wasmgame_redo(this.__wbg_ptr)!==0}}async function H(i,e){if(typeof Response=="function"&&i instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(i,e)}catch(n){if(i.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n);else throw n}const t=await i.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(i,e);return t instanceof WebAssembly.Instance?{instance:t,module:i}:t}}function J(){const i={};return i.wbg={},i.wbg.__wbg_error_524f506f44df1645=function(e){console.error(e)},i.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let n,s;try{n=e,s=t,console.error(h(e,t))}finally{a.__wbindgen_free(n,s,1)}},i.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},i.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){const n=t.stack,s=E(n,a.__wbindgen_malloc,a.__wbindgen_realloc),r=m;x().setInt32(e+4*1,r,!0),x().setInt32(e+4*0,s,!0)},i.wbg.__wbindgen_init_externref_table=function(){const e=a.__wbindgen_export_3,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)},i.wbg.__wbindgen_string_new=function(e,t){return h(e,t)},i.wbg.__wbindgen_throw=function(e,t){throw new Error(h(e,t))},i}function X(i,e){return a=i.exports,N.__wbindgen_wasm_module=e,g=null,w=null,a.__wbindgen_start(),a}async function N(i){if(a!==void 0)return a;typeof i<"u"&&(Object.getPrototypeOf(i)===Object.prototype?{module_or_path:i}=i:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof i>"u"&&(i=new URL("/pages/chess/assets/bitboard_x_bg-De3thJ2X.wasm",import.meta.url));const e=J();(typeof i=="string"||typeof Request=="function"&&i instanceof Request||typeof URL=="function"&&i instanceof URL)&&(i=fetch(i));const{instance:t,module:n}=await H(await i,e);return X(t,n)}function Z(i){let e="";const t=i.split("/").reverse();for(const n of t)for(const s of n){const r=s.charCodeAt(0)-48;r>=1&&r<=8?e+=".".repeat(r):e+=s}return e}function ee(i){const[e]=i.split(" ");return{board:Z(e)}}class te{constructor(){this._fen="",this._board="",this._moveLookup=new Map}set(e,t){if(e===this._fen)return!1;const{board:n}=ee(e);return this._board=n,this._moveLookup.clear(),t.forEach(s=>{var c;const r=s.slice(0,2),o=s.slice(2,4);this._moveLookup.has(r)||this._moveLookup.set(r,new Set),(c=this._moveLookup.get(r))==null||c.add(o)}),!0}get board(){return this._board}legalMoves(e){return this._moveLookup.get(e)}}class ne{constructor(){this.game=null,this._selected=null,this.canvas=null,this.waitingForInput=!1,this._board=new te}newgame(e){var t;if(!this.game)return console.error("Game not initialized. Cannot restart."),!1;e=e||((t=document.getElementById("fenInput"))==null?void 0:t.value)||R,this.waitingForInput=!1;try{const n=s=>{const r=document.querySelector(`input[name="${s}"]:checked`);return r&&r instanceof HTMLInputElement?r.value==="computer":!1};return console.log("Starting a new game >>>>>>"),this.canvas=l.display.canvas,this.game.reset_game(e,!n("player1"),!n("player2")),this.updateBoard(),l.messageQueue.emit(f.REQUEST_PLAYER_INPUT),!0}catch(n){return console.error(`Error parsing FEN '${e}': ${n}`),!1}}get board(){return this._board}handleMessage(e){const[t]=e.split(":");switch(t){case f.NEW_GAME:this.newgame(void 0);break;case f.REQUEST_PLAYER_INPUT:this.onRequestPlayerInput();break;case f.ANIMATION_DONE:l.messageQueue.emit(f.REQUEST_PLAYER_INPUT);break}}onRequestPlayerInput(){var e;if(!((e=this.game)!=null&&e.game_over())){this.waitingForInput=!0;return}alert("Game over!"),this.newgame(R)}updateBoard(){this.game&&this._board.set(this.game.fen(),this.game.get_legal_moves())&&console.log(this.game.debug_string())}get selectedPiece(){return this._selected}init(){return l.messageQueue.subscribe(f.NEW_GAME,this),l.messageQueue.subscribe(f.REQUEST_PLAYER_INPUT,this),l.messageQueue.subscribe(f.ANIMATION_DONE,this),this.game=new K,this.newgame(void 0)}tick(){if(!(!this.game||!this._board)&&this.waitingForInput){const e=this.game.get_move();e&&(this.game.make_move(e)?(l.messageQueue.emit(`${f.MOVE}:${e}`),this.waitingForInput=!1,this.updateBoard()):l.messageQueue.emit(f.REQUEST_PLAYER_INPUT))}}injectMove(e){if(!this.game){console.error("Game not initialized. Cannot inject move.");return}this.game.inject_move(e)}}const se="rgba(0, 200, 0, 0.5)",ie="rgba(200, 0, 0, 0.5)";function re(){const i=new Map;return["P","N","B","R","Q","K","p","n","b","r","q","k"].forEach(t=>{const s=`img-${P(t)?"b":"w"}${t.toUpperCase()}`,r=document.getElementById(s);i[t]=r}),i}function b(){return l.display.tileSize}class oe{constructor(){this.ctx=null,this.images=re()}init(){return this.ctx=l.display.canvas.getContext("2d"),this.ctx?(this.ctx.font="40px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",!0):!1}tick(){const e=l.display.canvas,{ctx:t}=this;t&&(t.clearRect(0,0,e.clientWidth,e.clientHeight),t.font=`${l.display.tileSize/2}px Arial`,this.drawBoard(),this.drawPieces(l.gameManager.board.board))}fillSquare(e,t,n){if(!this.ctx)return;const s=b();this.ctx.fillStyle=n,this.ctx.fillRect(e*s,t*s,s,s)}drawBoard(){const{ctx:e}=this;if(!e)return;const{moves:t,square:n}=I,s=b();for(let r=0;r<_;r++)for(let o=0;o<_;o++){const c=(r+o)%2===0?k.light:k.dark;this.fillSquare(o,r,c);const u=T(o,7-r);u===n?this.fillSquare(o,r,se):t&&t.has(u)&&this.fillSquare(o,r,ie)}e.fillStyle="black";for(let r=0;r<_;++r){const o=r*s+s/2,c=_*s+s/2;e.fillText(String.fromCharCode(97+r).toString(),o,c)}for(let r=0;r<_;r++){const o=_*s+s/2,c=r*s+s/2;e.fillText((8-r).toString(),o,c)}}drawPiece(e,t,n){if(!this.ctx)return;const s=b(),r=this.images[e];if(r){const o=s/2;this.ctx.drawImage(r,t-o,n-o,s,s)}else this.ctx.fillStyle=P(e)?"black":"white",this.ctx.fillText(W[e],t,n)}drawPieces(e){if(!this.ctx)return;const t=new Set,n=b(),{animations:s}=l.animationManager;for(const r of s){const{piece:o,dstFile:c,dstRank:u}=r,p=c+u*_;t.add(p);const d=r.x*n+n/2,M=r.y*n+n/2;this.drawPiece(o,d,M)}for(let r=0;r<_;++r)for(let o=0;o<_;++o){const c=(7-r)*_+o,u=e[c];if(u==="."||t.has(c))continue;const p=o*n+n/2,d=r*n+n/2;this.drawPiece(u,p,d)}}}class ae{constructor(){this.messageQueue=new F,this.animationManager=new D,this.display=new G,this.renderer=new oe,this.gameManager=new ne,this.modules=[this.animationManager,this.display,this.renderer,this.gameManager,this.messageQueue]}addModule(e){this.modules.push(e)}init(){for(const e of this.modules)if(!e.init())return!1;return!0}tick(){for(const e of this.modules)e.tick()}}const l=new ae;function O(){l.tick(),requestAnimationFrame(O)}async function ce(){await N(),console.log(`Running ${Y()}`),l.init()&&O()}ce();
