(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();let o;function m(s){const e=o.__externref_table_alloc();return o.__wbindgen_export_2.set(e,s),e}function Q(s,e){try{return s.apply(this,e)}catch(t){const n=m(t);o.__wbindgen_exn_store(n)}}const D=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&D.decode();let v=null;function S(){return(v===null||v.byteLength===0)&&(v=new Uint8Array(o.memory.buffer)),v}function d(s,e){return s=s>>>0,D.decode(S().subarray(s,s+e))}function y(s){return s==null}let b=0;const M=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},j=typeof M.encodeInto=="function"?function(s,e){return M.encodeInto(s,e)}:function(s,e){const t=M.encode(s);return e.set(t),{read:s.length,written:t.length}};function x(s,e,t){if(t===void 0){const _=M.encode(s),c=e(_.length,1)>>>0;return S().subarray(c,c+_.length).set(_),b=_.length,c}let n=s.length,r=e(n,1)>>>0;const i=S();let a=0;for(;a<n;a++){const _=s.charCodeAt(a);if(_>127)break;i[r+a]=_}if(a!==n){a!==0&&(s=s.slice(a)),r=t(r,n,n=a+s.length*3,1)>>>0;const _=S().subarray(r+a,r+n),c=j(s,_);a+=c.written,r=t(r,n,a,1)>>>0}return b=a,r}let w=null;function k(){return(w===null||w.buffer.detached===!0||w.buffer.detached===void 0&&w.buffer!==o.memory.buffer)&&(w=new DataView(o.memory.buffer)),w}function H(){let s,e;try{const t=o.name();return s=t[0],e=t[1],d(t[0],t[1])}finally{o.__wbindgen_free(s,e,1)}}function X(s,e){s=s>>>0;const t=k(),n=[];for(let r=s;r<s+4*e;r+=4)n.push(o.__wbindgen_export_2.get(t.getUint32(r,!0)));return o.__externref_drop_slice(s,e),n}const C=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(s=>o.__wbg_wasmengine_free(s>>>0,1));class Y{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,C.unregister(this),e}free(){const e=this.__destroy_into_raw();o.__wbg_wasmengine_free(e,0)}constructor(){const e=o.wasmengine_new();return this.__wbg_ptr=e>>>0,C.register(this,this.__wbg_ptr,this),this}set_position(e){const t=x(e,o.__wbindgen_malloc,o.__wbindgen_realloc),n=b;o.wasmengine_set_position(this.__wbg_ptr,t,n)}best_move(e){let t,n;try{const r=o.wasmengine_best_move(this.__wbg_ptr,e);return t=r[0],n=r[1],d(r[0],r[1])}finally{o.__wbindgen_free(t,n,1)}}}const L=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(s=>o.__wbg_wasmgame_free(s>>>0,1));class J{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,L.unregister(this),e}free(){const e=this.__destroy_into_raw();o.__wbg_wasmgame_free(e,0)}constructor(e){const t=x(e,o.__wbindgen_malloc,o.__wbindgen_realloc),n=b,r=o.wasmgame_new(t,n);return this.__wbg_ptr=r>>>0,L.register(this,this.__wbg_ptr,this),this}fen(){let e,t;try{const n=o.wasmgame_fen(this.__wbg_ptr);return e=n[0],t=n[1],d(n[0],n[1])}finally{o.__wbindgen_free(e,t,1)}}debug_string(){let e,t;try{const n=o.wasmgame_debug_string(this.__wbg_ptr);return e=n[0],t=n[1],d(n[0],n[1])}finally{o.__wbindgen_free(e,t,1)}}board_string(){let e,t;try{const n=o.wasmgame_board_string(this.__wbg_ptr);return e=n[0],t=n[1],d(n[0],n[1])}finally{o.__wbindgen_free(e,t,1)}}legal_moves(){const e=o.wasmgame_legal_moves(this.__wbg_ptr);var t=X(e[0],e[1]).slice();return o.__wbindgen_free(e[0],e[1]*4,4),t}turn(){return o.wasmgame_turn(this.__wbg_ptr)}make_move(e){const t=x(e,o.__wbindgen_malloc,o.__wbindgen_realloc),n=b,r=o.wasmgame_make_move(this.__wbg_ptr,t,n);return r===0?void 0:A.__wrap(r)}get_result(){let e,t;try{const n=o.wasmgame_get_result(this.__wbg_ptr);return e=n[0],t=n[1],d(n[0],n[1])}finally{o.__wbindgen_free(e,t,1)}}undo(){return o.wasmgame_undo(this.__wbg_ptr)!==0}}const T=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(s=>o.__wbg_wasmmove_free(s>>>0,1));class A{static __wrap(e){e=e>>>0;const t=Object.create(A.prototype);return t.__wbg_ptr=e,T.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,T.unregister(this),e}free(){const e=this.__destroy_into_raw();o.__wbg_wasmmove_free(e,0)}src_sq(){let e,t;try{const n=o.wasmmove_src_sq(this.__wbg_ptr);return e=n[0],t=n[1],d(n[0],n[1])}finally{o.__wbindgen_free(e,t,1)}}dst_sq(){let e,t;try{const n=o.wasmmove_dst_sq(this.__wbg_ptr);return e=n[0],t=n[1],d(n[0],n[1])}finally{o.__wbindgen_free(e,t,1)}}get_promotion(){const e=o.wasmmove_get_promotion(this.__wbg_ptr);return String.fromCodePoint(e)}get_captured(){const e=o.wasmmove_get_captured(this.__wbg_ptr);return String.fromCodePoint(e)}get_type(){return o.wasmmove_get_type(this.__wbg_ptr)}is_castling(){return o.wasmmove_is_castling(this.__wbg_ptr)!==0}is_en_passant(){return o.wasmmove_is_en_passant(this.__wbg_ptr)!==0}is_promotion(){return o.wasmmove_is_promotion(this.__wbg_ptr)!==0}to_string(){let e,t;try{const n=o.wasmmove_to_string(this.__wbg_ptr);return e=n[0],t=n[1],d(n[0],n[1])}finally{o.__wbindgen_free(e,t,1)}}}async function Z(s,e){if(typeof Response=="function"&&s instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(s,e)}catch(n){if(s.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n);else throw n}const t=await s.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(s,e);return t instanceof WebAssembly.Instance?{instance:t,module:s}:t}}function ee(){const s={};return s.wbg={},s.wbg.__wbg_call_672a4d21634d4a24=function(){return Q(function(e,t){return e.call(t)},arguments)},s.wbg.__wbg_debug_e17b51583ca6a632=function(e,t,n,r){console.debug(e,t,n,r)},s.wbg.__wbg_error_524f506f44df1645=function(e){console.error(e)},s.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let n,r;try{n=e,r=t,console.error(d(e,t))}finally{o.__wbindgen_free(n,r,1)}},s.wbg.__wbg_error_80de38b3f7cc3c3c=function(e,t,n,r){console.error(e,t,n,r)},s.wbg.__wbg_info_033d8b8a0838f1d3=function(e,t,n,r){console.info(e,t,n,r)},s.wbg.__wbg_instanceof_Window_def73ea0955fc569=function(e){let t;try{t=e instanceof Window}catch{t=!1}return t},s.wbg.__wbg_log_cad59bb680daec67=function(e,t,n,r){console.log(e,t,n,r)},s.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},s.wbg.__wbg_newnoargs_105ed471475aaf50=function(e,t){return new Function(d(e,t))},s.wbg.__wbg_now_d18023d54d4e5500=function(e){return e.now()},s.wbg.__wbg_performance_c185c0cdc2766575=function(e){const t=e.performance;return y(t)?0:m(t)},s.wbg.__wbg_random_3ad904d98382defe=function(){return Math.random()},s.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){const n=t.stack,r=x(n,o.__wbindgen_malloc,o.__wbindgen_realloc),i=b;k().setInt32(e+4*1,i,!0),k().setInt32(e+4*0,r,!0)},s.wbg.__wbg_static_accessor_GLOBAL_88a902d13a557d07=function(){const e=typeof global>"u"?null:global;return y(e)?0:m(e)},s.wbg.__wbg_static_accessor_GLOBAL_THIS_56578be7e9f832b0=function(){const e=typeof globalThis>"u"?null:globalThis;return y(e)?0:m(e)},s.wbg.__wbg_static_accessor_SELF_37c5d418e4bf5819=function(){const e=typeof self>"u"?null:self;return y(e)?0:m(e)},s.wbg.__wbg_static_accessor_WINDOW_5de37043a91a9c40=function(){const e=typeof window>"u"?null:window;return y(e)?0:m(e)},s.wbg.__wbg_warn_aaf1f4664a035bd6=function(e,t,n,r){console.warn(e,t,n,r)},s.wbg.__wbindgen_init_externref_table=function(){const e=o.__wbindgen_export_2,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)},s.wbg.__wbindgen_is_undefined=function(e){return e===void 0},s.wbg.__wbindgen_string_new=function(e,t){return d(e,t)},s.wbg.__wbindgen_throw=function(e,t){throw new Error(d(e,t))},s}function te(s,e){return o=s.exports,N.__wbindgen_wasm_module=e,w=null,v=null,o.__wbindgen_start(),o}async function N(s){if(o!==void 0)return o;typeof s<"u"&&(Object.getPrototypeOf(s)===Object.prototype?{module_or_path:s}=s:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof s>"u"&&(s=new URL("/pages/chess/assets/bitboard_x_bg-DxFR810X.wasm",import.meta.url));const e=ee();(typeof s=="string"||typeof Request=="function"&&s instanceof Request||typeof URL=="function"&&s instanceof URL)&&(s=fetch(s));const{instance:t,module:n}=await Z(await s,e);return te(t,n)}class G{setOnClickCallback(e){this.onclickCallback=e}}class ne extends G{update(e,t){console.error("NullBoardView.draw called, this should not happen")}addAnimation(e,t){console.error("NullBoardView.addAnimation called, this should not happen")}hasAnimations(){return console.error("NullBoardView.hasAnimations called, this should not happen"),!1}}const re="rgba(0, 200, 0, 0.5)",se="rgba(200, 0, 0, 0.5)",ie="rgba(200, 200, 0, 0.5)",z="rgba(240, 217, 181, 1)",O="rgba(181, 136, 99, 1)",U=new Map,B=["wP","wN","wB","wR","wQ","wK","bP","bN","bB","bR","bQ","bK"];async function oe(s){return new Promise((e,t)=>{const n=new Image,r=`https://lichess1.org/assets/piece/cburnett/${s}.svg`;n.src=r,n.onload=()=>e(n),n.onerror=()=>t(new Error(`Failed to load: ${r}`))})}async function ae(s){if(!s)throw new Error("Canvas element is required");return(await Promise.all(B.map(oe))).forEach((t,n)=>{const r=B[n],a=r[0]==="w"?r[1]:r[1].toLowerCase();U.set(a,t)}),console.log("✅ All assets loaded"),new ce(s)}class ce extends G{constructor(e){if(super(),this.squareSize=0,this.animations=[],this.elapsed=null,this.canvas=e,e.addEventListener("resize",()=>{this.onResize()}),e.addEventListener("click",t=>{var n;(n=this.onclickCallback)==null||n.call(this,this.screenToSquare(t.offsetX,t.offsetY))}),this.onResize(),this.ctx=e.getContext("2d"),!this.ctx)throw new Error("Failed to get canvas context")}addAnimation(e,t){const n=t.src_sq(),r=t.dst_sq();this.addAnimationImpl(e,n,r),e==="K"&&n==="e1"?r==="g1"?this.addAnimationImpl("R","h1","f1"):r==="c1"&&this.addAnimationImpl("R","a1","d1"):e==="k"&&n==="e8"&&(r==="g8"?this.addAnimationImpl("r","h8","f8"):r==="c8"&&this.addAnimationImpl("r","a8","d8"))}addAnimationImpl(e,t,n){const[r,i]=this.squareToScreen(t),[a,_]=this.squareToScreen(n),c=a-r,l=_-i,f=100,g=500,u=Math.sqrt(7*7+7*7),p=Math.sqrt(c*c+l*l),V=Math.min(p/u,1),E=f+(g-f)*Math.sqrt(V),K={piece:e,x:r,y:i,dx:c/E,dy:l/E,dstSq:n,timeLeft:E};this.animations.push(K)}hasAnimations(){return this.animations.length>0}update(e,t){if(this.elapsed===null)this.elapsed=performance.now();else{const n=performance.now(),r=n-this.elapsed;this.elapsed=n,this.animations.forEach(i=>{i.x+=i.dx*r,i.y+=i.dy*r,i.timeLeft-=r}),this.animations=this.animations.filter(i=>i.timeLeft>0)}this.draw(e,t)}draw(e,t){const{ctx:n,canvas:r}=this,{width:i,height:a}=r;e&&(n.clearRect(0,0,i,a),this.drawBoard(e,t),this.drawPieces(e))}fillSquare(e,t,n){const{squareSize:r,ctx:i}=this;i.fillStyle=n,i.fillRect(e*r,t*r,r,r)}drawBoard(e,t){const{ctx:n,squareSize:r}=this;t=t||"";const i=e.legalMovesMap.get(t),a=e.lastMove();for(let c=0;c<64;++c){const[l,f]=F(c),g=P(l,f),u=7-f;this.fillSquare(l,u,(u+l)%2===0?z:O),g===t?this.fillSquare(l,u,se):i&&i.has(g)&&this.fillSquare(l,u,re),a&&(g===a.src_sq()||g===a.dst_sq())&&this.fillSquare(l,u,ie)}const _=Math.floor(r/4);n.font=`${_}px Arial`,n.textAlign="center";for(let c=0;c<8;++c){const l=c%2===0?z:O,f=String.fromCharCode(97+c),g=(c+1).toString();n.fillStyle=l;let u=(c+.88)*r,p=7.93*r;n.fillText(f,u,p),u=.1*r,p=(7.3-c)*r,n.fillText(g,u,p)}}drawPiece(e,t,n){const r=this.squareSize*.86,i=r/2,a=U.get(e);a&&this.ctx.drawImage(a,t-i,n-i,r,r)}drawPieces(e){const{boardString:t}=e,n=new Set;this.animations.forEach(r=>{const{x:i,y:a,dstSq:_}=r;this.drawPiece(r.piece,i,a),n.add(_)});for(let r=0;r<64;++r){const i=t[r];if(i===".")continue;const[a,_]=F(r),c=P(a,_);if(n.has(c))continue;const[l,f]=this.fileRankToScreen(a,_);this.drawPiece(i,l,f)}}onResize(){const{clientWidth:e,clientHeight:t}=this.canvas,r=Math.max(200,Math.min(e,t));this.canvas.width=r,this.canvas.height=r,this.squareSize=r/8}screenToSquare(e,t){const n=Math.floor(e/this.squareSize),r=7-Math.floor(t/this.squareSize);return P(n,r)}squareToScreen(e){const t=e.charCodeAt(0)-97,n=parseInt(e[1],10)-1;return this.fileRankToScreen(t,n)}fileRankToScreen(e,t){const{squareSize:n}=this;return[e*n+n/2,(7-t)*n+n/2]}}function F(s){return[s%8,Math.floor(s/8)]}function P(s,e){return`${String.fromCharCode(97+s)}${e+1}`}async function le(s){return await N(),h=await ae(s.canvas),h==null||h.setOnClickCallback(e=>q.onSquareClicked(e)),console.log(`✅ Initializing engine ${H()}`),R=new Y,I}class _e{constructor(e){this._boardString="",this._legalMoves=[],this._legalMovesMap=new Map,this._gameState=new J(e),this.initialPos=`fen ${e}`,this._history=[],this.updateInternal()}get gameState(){return this._gameState}get boardString(){return this._boardString}get legalMovesMap(){return this._legalMovesMap}uciPosition(){const{_history:e,initialPos:t}=this,n=e.length>0?`moves ${e.map(i=>i.to_string()).join(" ")}`:"";return`${t} ${n}`}lastMove(){return this._history.length>0?this._history[this._history.length-1]:null}updateInternal(){var e;this._boardString=this.gameState.board_string(),this._legalMoves=this.gameState.legal_moves(),this._legalMovesMap.clear();for(const t of this._legalMoves){const n=t.slice(0,2),r=t.slice(2,4);this._legalMovesMap.has(n)||this._legalMovesMap.set(n,new Set),(e=this._legalMovesMap.get(n))==null||e.add(r)}}turn(){return this.gameState.turn()}makeMove(e){const t=this.gameState.make_move(e);return t&&(this._history.push(t),this.updateInternal()),t}undo(){this.gameState.undo()&&(this.updateInternal(),this._history.pop())}getPieceAt(e){const t=e.charCodeAt(0)-97,r=(parseInt(e[1],10)-1)*8+t;return this._boardString[r]}}class de{constructor(){this.bufferedMove=null,this.selectingPromotion=!1,this.controller=I}tryGetMove(){const e=this.bufferedMove;return this.bufferedMove=null,e}async onSquareClicked(e){var n;if(I.resume(),this.selectingPromotion)return;const{board:t}=this.controller;if(this.selected&&(n=t.legalMovesMap.get(this.selected))!=null&&n.has(e)){this.bufferedMove=await this.getMove(this.selected,e),this.selected=void 0;return}t.legalMovesMap.has(e)&&(this.selected=e)}async getMove(e,t){const r=this.controller.board.getPieceAt(e);let i="";if(r==="P"&&t[1]==="8"||r==="p"&&t[1]==="1"){const _=r==="P";this.selectingPromotion=!0,i=await this.waitForPromotionSelection(_),this.selectingPromotion=!1}return`${e}${t}${i}`}waitForPromotionSelection(e){return new Promise(r=>{const i=document.createElement("div");i.id="promotion-dialog",i.style.position="absolute",i.style.left="100px",i.style.top="100px",i.style.display="flex",i.style.gap="8px",i.style.zIndex="9999",i.style.background="rgba(255, 255, 255, 0.95)",i.style.padding="6px",i.style.border="1px solid #ccc",i.style.borderRadius="4px",i.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)";const a=["Q","R","B","N"];for(const _ of a){const c=`https://lichess1.org/assets/piece/cburnett/${e?"w":"b"}${_}.svg`,l=document.createElement("div");l.style.width="64px",l.style.height="64px",l.style.cursor="pointer",l.style.backgroundImage=`url(${c})`,l.style.backgroundSize="contain",l.style.backgroundRepeat="no-repeat",l.style.backgroundPosition="center",l.onclick=()=>{document.body.removeChild(i),r(_)},i.appendChild(l)}document.body.appendChild(i)})}}class ue{constructor(){this.gameState="waitingInput",this.result="playing",this.players=[new W,new W]}get board(){return this._board}newGame(e,t,n){this.players=[e,t],this._board=new _e(n||we),this.gameState="waitingInput",this.loop()}async loop(){const e=this._board;if(h.update(e,q.selected),this.result!=="playing"){alert(this.result);return}switch(this.gameState){case"waitingInput":{const n=await this.players[e.turn()].tryGetMove(e.uciPosition());if(n){const r=e.makeMove(n);if(r){const i=e.getPieceAt(r.dst_sq());console.log(e.gameState.debug_string()),this.result=e.gameState.get_result(),this.gameState="animating",h.addAnimation(i,r)}}}break;case"paused":break;case"animating":h.hasAnimations()||(this.gameState="waitingInput");break;default:throw new Error(`Unknown game state: ${this.gameState}`)}await new Promise(requestAnimationFrame),this.loop()}undo(){this._board&&this.gameState!=="animating"&&(this._board.undo(),this.gameState="paused",this.result="playing")}resume(){this.gameState==="paused"&&(this.gameState="waitingInput")}}class W{async tryGetMove(e){return""}}class fe{async tryGetMove(e){return R.set_position(e),R.best_move(2e3)}}class ge{async tryGetMove(e){return q.tryGetMove()}}const we="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",I=new ue,q=new de;let h=new ne,R=null;function $(){const s=i=>{const a=document.querySelector(`input[name="${i}"]:checked`);if(a&&a instanceof HTMLInputElement){if(a.value==="bot")return new fe;if(a.value==="human")return new ge}throw new Error(`Invalid player: ${i}`)},e=s("white-player"),t=s("black-player"),r=document.getElementById("fen-input").value;return[e,t,r]}async function he(){var t,n,r;const s=document.getElementById("chess-board");s.tabIndex=0;const e=await le({canvas:s});(t=document.getElementById("start-button"))==null||t.addEventListener("click",async()=>{console.log("Starting new game..."),e.newGame(...$())}),(n=document.getElementById("resume-button"))==null||n.addEventListener("click",()=>{e.resume()}),(r=document.getElementById("undo-button"))==null||r.addEventListener("click",()=>{e.undo()}),e.newGame(...$())}he();
